"""McDonald's Drive-Thru Agent CLI.

This module provides the command-line interface for running the drive-thru agent
in various modes (console, dev, production).
"""

import asyncio
from uuid import uuid4

import click
from dotenv import load_dotenv
from livekit.agents import AgentServer, JobContext, JobProcess, cli
from livekit.agents.testing import Console
from livekit.plugins import silero
from loguru import logger

from config import AppConfig
from session_handler import DriveThruSessionHandler

# Load environment variables
load_dotenv(".env.local")


@click.group()
def agent_cli():
    """McDonald's Drive-Thru Agent CLI."""
    pass


@agent_cli.command()
def console():
    """Run drive-thru agent in console mode (for testing).

    This mode allows you to interact with the agent directly in the terminal,
    which is useful for testing and debugging.
    """

    async def run_console():
        """Async console runner."""
        # Load configuration
        config = AppConfig()

        # Create session handler
        handler = DriveThruSessionHandler(config)

        # Create agent for console session
        session_id = str(uuid4())
        logger.info(f"Starting console session: {session_id}")

        agent = await handler.create_agent(session_id)

        # Run console session
        logger.info("Console ready. Start speaking to the agent.")
        async with Console(agent.agent) as console_session:
            await console_session.run()

    # Run the async console
    asyncio.run(run_console())


@agent_cli.command()
def dev():
    """Run drive-thru agent in dev mode with LiveKit connection.

    This mode connects to LiveKit for testing with real voice interactions.
    """
    # Load configuration
    config = AppConfig()

    # Create session handler
    handler = DriveThruSessionHandler(config)

    # Create server
    server = AgentServer()

    # Setup prewarm for VAD
    @server.setup_fnc
    def prewarm(proc: JobProcess):
        """Prewarm function for loading VAD model."""
        proc.userdata["vad"] = silero.VAD.load()

    # Register session handler
    @server.rtc_session()
    async def handle_rtc_session(ctx: JobContext):
        """Handle an RTC session."""
        session_id = ctx.room.name  # Use room name as session ID

        logger.info(f"Starting drive-thru session for room: {session_id}")

        # Create agent
        drive_thru_agent = await handler.create_agent(session_id)

        # Connect to room
        await ctx.connect()

        # Start the agent's internal session
        # The agent will manage the session lifecycle
        logger.info("Drive-thru agent ready in dev mode")

        # The agent manages its own session via AgentSession
        # We just need to keep the connection alive
        # The DriveThruAgent.agent property provides the LiveKit Agent
        # that will handle the conversation

    logger.info("Starting drive-thru agent in dev mode")
    cli.run_app(server)


@agent_cli.command()
def start():
    """Run drive-thru agent in production mode.

    This is the production entry point for deployment.
    """
    # Load configuration
    config = AppConfig()

    # Create session handler
    handler = DriveThruSessionHandler(config)

    # Create server
    server = AgentServer()

    # Setup prewarm for VAD
    @server.setup_fnc
    def prewarm(proc: JobProcess):
        """Prewarm function for loading VAD model."""
        proc.userdata["vad"] = silero.VAD.load()

    # Register session handler
    @server.rtc_session()
    async def handle_rtc_session(ctx: JobContext):
        """Handle an RTC session."""
        session_id = ctx.room.name

        logger.info(f"Production session for room: {session_id}")

        # Create agent
        drive_thru_agent = await handler.create_agent(session_id)

        # Connect to room
        await ctx.connect()

        logger.info("Drive-thru agent ready in production mode")

    logger.info("Starting drive-thru agent in production mode")
    cli.run_app(server)


@agent_cli.command()
def download_files():
    """Download required model files (VAD, turn detector, etc.).

    Run this before your first session to download necessary models.
    """
    from livekit.plugins import silero
    from livekit.plugins.turn_detector.multilingual import MultilingualModel

    click.echo("Downloading Silero VAD model...")
    silero.VAD.load()
    click.echo("✓ Silero VAD model downloaded")

    click.echo("Downloading multilingual turn detector...")
    MultilingualModel.load()
    click.echo("✓ Multilingual turn detector downloaded")

    click.echo("\nAll models downloaded successfully!")


if __name__ == "__main__":
    agent_cli()
