#!/usr/bin/env python3
"""
Delete GitHub repositories created in 2018 or earlier.
"""

import json
import subprocess
import sys
from datetime import datetime


def get_repos_by_year(username, max_year):
    """Get all repositories created on or before max_year."""
    print(f"Fetching repositories for {username}...")

    try:
        result = subprocess.run(
            ["gh", "repo", "list", username, "--limit", "1000", "--json", "name,createdAt,viewerPermission,isFork"],
            capture_output=True,
            text=True,
            check=True
        )

        repos = json.loads(result.stdout)

        # Filter repos by year
        old_repos = []
        for repo in repos:
            created_at = datetime.fromisoformat(repo["createdAt"].replace("Z", "+00:00"))
            if created_at.year <= max_year:
                old_repos.append({
                    "name": repo["name"],
                    "year": created_at.year,
                    "permission": repo.get("viewerPermission", "NONE"),
                    "is_fork": repo.get("isFork", False)
                })

        return old_repos

    except subprocess.CalledProcessError as e:
        print(f"Error fetching repositories: {e.stderr}")
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"Error parsing JSON: {e}")
        sys.exit(1)


def delete_repo(username, repo_name):
    """Delete a single repository."""
    full_name = f"{username}/{repo_name}"

    try:
        subprocess.run(
            ["gh", "repo", "delete", full_name, "--yes"],
            capture_output=True,
            text=True,
            check=True
        )
        return True, None
    except subprocess.CalledProcessError as e:
        return False, e.stderr


def main():
    username = "seanreed1111"
    max_year = 2018

    # Get repos to delete
    all_repos = get_repos_by_year(username, max_year)

    if not all_repos:
        print(f"No repositories found from {max_year} or earlier.")
        return

    # Separate repos by permission
    can_delete = []
    cannot_delete = []

    for repo in all_repos:
        if repo["permission"] == "ADMIN":
            can_delete.append(repo)
        else:
            cannot_delete.append(repo)

    # Show summary
    print(f"\nFound {len(all_repos)} repositories from {max_year} or earlier:")
    print(f"  - Can delete (admin access): {len(can_delete)}")
    print(f"  - Cannot delete (no admin access): {len(cannot_delete)}")

    # Show repos that cannot be deleted
    if cannot_delete:
        print(f"\n⚠️  Repositories without admin access (will be skipped):")
        for repo in cannot_delete:
            fork_label = " [FORK]" if repo["is_fork"] else ""
            print(f"  - {repo['name']} ({repo['year']}){fork_label}")

    # Group deletable repos by year
    if can_delete:
        by_year = {}
        for repo in can_delete:
            year = repo["year"]
            by_year.setdefault(year, []).append(repo["name"])

        print(f"\nRepositories that will be deleted:")
        for year in sorted(by_year.keys()):
            print(f"  {year}: {len(by_year[year])} repos")

        # Confirm deletion
        print(f"\n⚠️  WARNING: This will permanently delete {len(can_delete)} repositories!")
        response = input("Type 'DELETE' to confirm: ")

        if response != "DELETE":
            print("Aborted.")
            return

        # Delete repos
        print(f"\nDeleting {len(can_delete)} repositories...")
        deleted = 0
        failed = []

        for i, repo in enumerate(can_delete, 1):
            repo_name = repo["name"]
            print(f"[{i}/{len(can_delete)}] Deleting {repo_name}...", end=" ")

            success, error = delete_repo(username, repo_name)

            if success:
                print("✓")
                deleted += 1
            else:
                print("✗")
                failed.append((repo_name, error))

        # Summary
        print(f"\n{'='*60}")
        print(f"Deleted: {deleted}/{len(can_delete)}")

        if failed:
            print(f"Failed: {len(failed)}")
            print("\nFailed repositories:")
            for name, error in failed:
                print(f"  - {name}: {error.strip()}")
    else:
        print("\nNo repositories with admin access to delete.")


if __name__ == "__main__":
    main()
