#!/usr/bin/env python3
"""
Export GitHub repositories sorted by year and alphabetically.
"""

import json
import subprocess
import sys
from datetime import datetime
from collections import defaultdict


def get_all_repos(username):
    """Get all repositories with creation dates."""
    print(f"Fetching repositories for {username}...")

    try:
        result = subprocess.run(
            ["gh", "repo", "list", username, "--limit", "1000", "--json", "name,createdAt,description,isPrivate,isFork"],
            capture_output=True,
            text=True,
            check=True
        )

        repos = json.loads(result.stdout)
        return repos

    except subprocess.CalledProcessError as e:
        print(f"Error fetching repositories: {e.stderr}")
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"Error parsing JSON: {e}")
        sys.exit(1)


def export_repos(username, output_file="repos_by_year.txt"):
    """Export repos grouped by year and sorted alphabetically."""
    repos = get_all_repos(username)

    if not repos:
        print("No repositories found.")
        return

    # Group repos by year
    by_year = defaultdict(list)

    for repo in repos:
        created_at = datetime.fromisoformat(repo["createdAt"].replace("Z", "+00:00"))
        year = created_at.year

        by_year[year].append({
            "name": repo["name"],
            "description": repo.get("description", ""),
            "is_private": repo.get("isPrivate", False),
            "is_fork": repo.get("isFork", False),
            "created_at": created_at
        })

    # Sort repos within each year alphabetically (case-insensitive)
    for year in by_year:
        by_year[year].sort(key=lambda x: x["name"].lower())

    # Write to file
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(f"GitHub Repositories for {username}\n")
        f.write(f"Total: {len(repos)} repositories\n")
        f.write("=" * 80 + "\n\n")

        for year in sorted(by_year.keys()):
            repos_in_year = by_year[year]
            f.write(f"{year} ({len(repos_in_year)} repos)\n")
            f.write("-" * 80 + "\n")

            for repo in repos_in_year:
                flags = []
                if repo["is_private"]:
                    flags.append("PRIVATE")
                if repo["is_fork"]:
                    flags.append("FORK")

                flag_str = f" [{', '.join(flags)}]" if flags else ""
                desc = repo["description"] or "No description"

                f.write(f"  {repo['name']}{flag_str}\n")
                f.write(f"    {desc}\n")
                f.write(f"    Created: {repo['created_at'].strftime('%Y-%m-%d')}\n\n")

            f.write("\n")

    print(f"\n✓ Exported {len(repos)} repositories to {output_file}")

    # Print summary
    print("\nSummary by year:")
    for year in sorted(by_year.keys()):
        print(f"  {year}: {len(by_year[year])} repos")


def export_repos_csv(username, output_file="repos_by_year.csv"):
    """Export repos to CSV format."""
    repos = get_all_repos(username)

    if not repos:
        print("No repositories found.")
        return

    # Prepare data
    repo_data = []
    for repo in repos:
        created_at = datetime.fromisoformat(repo["createdAt"].replace("Z", "+00:00"))
        repo_data.append({
            "name": repo["name"],
            "year": created_at.year,
            "created_at": created_at.strftime("%Y-%m-%d"),
            "description": repo.get("description", ""),
            "is_private": repo.get("isPrivate", False),
            "is_fork": repo.get("isFork", False)
        })

    # Sort by year, then alphabetically (case-insensitive)
    repo_data.sort(key=lambda x: (x["year"], x["name"].lower()))

    # Write CSV
    with open(output_file, "w", encoding="utf-8") as f:
        f.write("Year,Name,Created,Private,Fork,Description\n")
        for repo in repo_data:
            # Escape description for CSV
            desc = repo["description"].replace('"', '""')
            f.write(f'{repo["year"]},"{repo["name"]}",{repo["created_at"]},{repo["is_private"]},{repo["is_fork"]},"{desc}"\n')

    print(f"\n✓ Exported {len(repos)} repositories to {output_file}")


def main():
    username = "seanreed1111"

    print("Choose export format:")
    print("1. Text file (detailed, grouped by year)")
    print("2. CSV file (spreadsheet-friendly)")
    choice = input("\nEnter choice (1 or 2): ").strip()

    if choice == "1":
        export_repos(username)
    elif choice == "2":
        export_repos_csv(username)
    else:
        print("Invalid choice. Defaulting to text file.")
        export_repos(username)


if __name__ == "__main__":
    main()
