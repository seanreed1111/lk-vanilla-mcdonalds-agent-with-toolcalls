#!/usr/bin/env python3
"""Validate menu JSON against its schema."""

import json
from pathlib import Path


def validate_item(item_name: str, item_data: dict, category: str) -> list[str]:
    """Validate a single menu item."""
    errors = []

    # Check if item_data is a dict
    if not isinstance(item_data, dict):
        errors.append(f"{category} > {item_name}: Expected object, got {type(item_data).__name__}")
        return errors

    # Check required fields
    if "available_as_base" not in item_data:
        errors.append(f"{category} > {item_name}: Missing required field 'available_as_base'")

    if "variations" not in item_data:
        errors.append(f"{category} > {item_name}: Missing required field 'variations'")

    # Check field types
    if "available_as_base" in item_data:
        if not isinstance(item_data["available_as_base"], bool):
            errors.append(
                f"{category} > {item_name}: Field 'available_as_base' must be boolean, "
                f"got {type(item_data['available_as_base']).__name__}"
            )

    if "variations" in item_data:
        if not isinstance(item_data["variations"], list):
            errors.append(
                f"{category} > {item_name}: Field 'variations' must be array, "
                f"got {type(item_data['variations']).__name__}"
            )
        else:
            # Check that all variations are strings
            for i, variation in enumerate(item_data["variations"]):
                if not isinstance(variation, str):
                    errors.append(
                        f"{category} > {item_name} > variations[{i}]: "
                        f"Expected string, got {type(variation).__name__}"
                    )

    # Check for additional properties
    allowed_fields = {"available_as_base", "variations"}
    extra_fields = set(item_data.keys()) - allowed_fields
    if extra_fields:
        errors.append(
            f"{category} > {item_name}: Unexpected fields: {', '.join(extra_fields)}"
        )

    return errors


def validate_menu():
    """Validate the McDonald's menu JSON against its schema."""
    base_dir = Path(__file__).parent / "transformed-data"

    # Load the data
    data_path = base_dir / "menu-structure-2026-01-21.json"
    with open(data_path, "r") as f:
        data = json.load(f)

    # Validate structure
    all_errors = []

    # Check that root is an object
    if not isinstance(data, dict):
        print(f"✗ Validation failed: Root must be an object, got {type(data).__name__}")
        return False

    # Validate each category
    for category_name, category_items in data.items():
        # Check that category is an object
        if not isinstance(category_items, dict):
            all_errors.append(
                f"{category_name}: Expected object, got {type(category_items).__name__}"
            )
            continue

        # Validate each item in the category
        for item_name, item_data in category_items.items():
            errors = validate_item(item_name, item_data, category_name)
            all_errors.extend(errors)

    # Report results
    if all_errors:
        print("✗ Validation failed with the following errors:\n")
        for error in all_errors:
            print(f"  - {error}")
        return False
    else:
        print("✓ Validation successful! The JSON file conforms to the schema.")
        print(f"\n  Statistics:")
        print(f"  - Categories: {len(data)}")

        total_items = 0
        items_with_variations = 0
        total_variations = 0
        items_not_available_as_base = 0

        for category_items in data.values():
            total_items += len(category_items)

            for item_data in category_items.values():
                if item_data["variations"]:
                    items_with_variations += 1
                    total_variations += len(item_data["variations"])
                if not item_data["available_as_base"]:
                    items_not_available_as_base += 1

        print(f"  - Total items: {total_items}")
        print(f"  - Items with variations: {items_with_variations}")
        print(f"  - Total variations: {total_variations}")
        print(f"  - Items requiring variation selection: {items_not_available_as_base}")

        return True


if __name__ == "__main__":
    import sys

    success = validate_menu()
    sys.exit(0 if success else 1)
