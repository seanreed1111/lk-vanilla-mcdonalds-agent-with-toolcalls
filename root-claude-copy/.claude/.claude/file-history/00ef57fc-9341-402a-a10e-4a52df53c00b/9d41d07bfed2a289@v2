# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

This repository contains custom Claude Code commands (skills) and agents designed to implement a structured software development workflow. The system emphasizes plan-driven development with clear phases, automated verification, and tight integration with Linear for project management.

## Architecture Overview

### Core Components

**Commands (.claude/commands/)**: 27 executable skills that implement specific workflows
- Planning lifecycle: `create_plan`, `iterate_plan`, `implement_plan`, `validate_plan`
- Linear integration: `linear`, `ralph_plan`, `ralph_research`, `ralph_impl`
- Git operations: `commit`, `ci_commit`, `describe_pr`, `ci_describe_pr`
- Research: `research_codebase`, `research_codebase_nt`, `research_codebase_generic`
- Workflow automation: `founder_mode`, `oneshot`, `oneshot_plan`
- Developer utilities: `debug`, `local_review`, `create_worktree`, `create_handoff`, `resume_handoff`

**Agents (.claude/agents/)**: 6 specialized sub-agents for codebase exploration
- `codebase-locator`: Finds files and directories by feature/topic
- `codebase-analyzer`: Analyzes implementation details
- `codebase-pattern-finder`: Discovers similar implementations to model after
- `thoughts-locator`: Finds relevant documents in thoughts/ directory
- `thoughts-analyzer`: Deep analysis of historical context documents
- `web-search-researcher`: Web research for external information

### Development Philosophy

The workflow enforces **review at the plan stage, not the PR stage** to:
- Enable faster iteration and less rework
- Ensure alignment before implementation begins
- Create clear, actionable specifications with automated verification
- Separate automated verification from manual testing requirements

## Linear Workflow States

Tickets progress through these states (from .claude/commands/linear.md:364-382):
1. **Triage** → Initial review
2. **Spec Needed** → Requires problem definition
3. **Research Needed** → Investigation required
4. **Research in Progress** → Active research
5. **Research in Review** → Review findings (optional)
6. **Ready for Plan** → Ready for implementation plan
7. **Plan in Progress** → Writing plan
8. **Plan in Review** → Plan under discussion
9. **Ready for Dev** → Plan approved, ready to code
10. **In Dev** → Active implementation
11. **Code Review** → PR submitted
12. **Done** → Completed

## Common Commands

### Planning Workflow

```bash
/create_plan              # Interactive plan creation with research
/create_plan <ticket>     # Create plan from specific ticket
/implement_plan <path>    # Execute an approved plan
/validate_plan           # Verify implementation matches plan
/iterate_plan            # Refine existing plan
```

### Linear Integration

```bash
/linear                  # Ticket management interface
/ralph_plan             # Auto-select highest priority ticket, create plan
/ralph_research         # Auto-select ticket needing research
/ralph_impl             # Auto-select small ticket and implement
```

### Research & Exploration

```bash
/research_codebase       # Comprehensive codebase research with parallel agents
/research_codebase_nt    # Research without thoughts directory
/debug                   # Investigate issues via logs, DB, git history
```

### Git Operations

```bash
/commit                  # Create commits (no Claude attribution)
/ci_commit              # Create commits with Claude attribution
/describe_pr            # Generate PR description from template
/founder_mode           # Retroactively create ticket + PR for experimental work
```

### Development Utilities

```bash
/create_worktree        # Set up git worktree for parallel work
/local_review          # Set up worktree for reviewing colleague's branch
/create_handoff        # Document work for transfer to another session
/resume_handoff        # Resume work from handoff document
/oneshot               # Research ticket and launch planning session
/oneshot_plan          # Execute ralph plan + implementation in one go
```

## Implementation Plan Structure

Plans live in `thoughts/shared/plans/YYYY-MM-DD-ENG-XXXX-description.md`

Key sections (from .claude/commands/create_plan.md:182-277):
- **Overview**: Brief description
- **Current State Analysis**: What exists now
- **Desired End State**: Specification and verification criteria
- **What We're NOT Doing**: Explicit scope boundaries
- **Implementation Approach**: High-level strategy
- **Phases**: Each with:
  - Overview and changes required
  - **Automated Verification**: Commands that can be run (`make test`, etc.)
  - **Manual Verification**: Human testing steps
  - **Implementation Note**: Pause for manual confirmation before next phase
- **Testing Strategy**: Unit, integration, manual steps
- **References**: Links to tickets, research, similar implementations

## Agent Usage Patterns

Agents are spawned in parallel for efficiency (create_plan.md:400-433):

**When creating plans:**
1. Use `codebase-locator` to find relevant files
2. Use `codebase-analyzer` to understand current implementation
3. Use `thoughts-locator` for historical context
4. Use `codebase-pattern-finder` for similar implementations to model after

**Critical agent guidelines:**
- Spawn multiple agents in parallel when searching for different things
- Wait for ALL agents to complete before synthesizing
- Provide specific directory context (e.g., `humanlayer-wui/` not just "UI")
- Request specific file:line references in agent prompts
- Verify agent results against actual codebase if unexpected

## Important Conventions

### File Naming
- Plans: `YYYY-MM-DD-ENG-XXXX-description.md` (omit ticket number if none)
- Research: `YYYY-MM-DD-ENG-XXXX-description.md` in `thoughts/shared/research/`

### Success Criteria Format
Always separate into two categories:
- **Automated Verification**: Runnable commands (prefer `make` commands)
- **Manual Verification**: Human testing required
- Implementation should pause after automated verification for manual confirmation

### Thoughts Directory Integration
- Research documents use YAML frontmatter with metadata
- Run `humanlayer thoughts sync` after creating/updating documents
- Remove `searchable/` from paths when documenting (preserve other subdirectories)

### Linear Integration
- Default project: "M U L T I C L A U D E"
- Default status for new tickets: "Triage"
- Automatic label assignment: `hld` (daemon), `wui` (UI), `meta` (tooling)
- Use `links` parameter for attachments, not just markdown links
- All tickets require a "Problem to solve" section

### BDD and Gherkin
- When asked to write BDD scenarios or feature files, they should be written in Gherkin language
- Only implement steps corresponding to the scenarios when explicitly told to do so
- When writing authorization/authentication scenarios, write only a minimal set of five or less unless explicitly told otherwise

## Pre-configured Settings

From .claude/settings.json:
- **Allowed commands**: `./hack/spec_metadata.sh`, `hack/spec_metadata.sh`, `bash hack/spec_metadata.sh`
- **Environment**: `MAX_THINKING_TOKENS=32000`
- **MCP servers**: Not enabled by default (enableAllProjectMcpServers: false)

## Key Principles

1. **Read files fully**: Never use limit/offset parameters when reading context files
2. **Verify before planning**: Research actual code, don't assume
3. **No open questions in plans**: Resolve all uncertainties before finalizing
4. **Document as-is**: Agents describe what exists, not what should be
5. **Atomic commits**: Group related changes, use imperative mood
6. **Plan before code**: Get alignment on approach before implementation
7. **Parallel execution**: Spawn multiple agents/tasks concurrently when independent
